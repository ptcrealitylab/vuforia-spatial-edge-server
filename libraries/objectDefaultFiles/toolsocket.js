var ToolSocket=(()=>{var ce=(i=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(i,{get:(e,t)=>(typeof require<"u"?require:e)[t]}):i)(function(i){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+i+'" is not supported')});var h=(i,e)=>()=>(e||i((e={exports:{}}).exports,e),e.exports);var A=h((Xe,T)=>{var d=class{constructor(e){this.validators=e,this.failedValidator=null}get expectedKeys(){return this.validators.filter(e=>e.expected).map(e=>e.key)}get oldFormat(){let e={type:"object",items:{properties:{},required:this.validators.filter(r=>r.required).map(r=>r.key),expected:this.validators.filter(r=>r.expected).map(r=>r.key)}};function t(r){switch(r.constructor){case k:return"string";case v:return"number";case E:return"boolean";case S:return"null";case y:return"undefined";case b:return"array";case L:return"object";case w:return r.validators.map(n=>t(n))}}function s(r){if(r.constructor===w)return r.validators.reduce((o,u)=>(Object.entries(u).forEach(l=>{["required","expected","key"].includes(l[0])||l[1]!==null&&(o[l[0]]=l[1])}),o),{});let n={};return Object.entries(r).forEach(o=>{["required","expected"].includes(o[0])||(n[o[0]]=o[1])}),n}return this.validators.forEach(r=>{e.items.properties[r.key]={type:t(r),...s(r)}}),e}validate(e){for(let t of this.validators)if(!t.validate(e))return this.failedValidator=t,!1;return this.failedValidator=null,!0}parseUrl(e){let t=e.protocol.slice(0,-1),s;if(e.port!=="")s=parseInt(e.port);else if(["wss","https"].includes(t))s=443;else if(["ws","http"].includes(t))s=80;else return null;let r=this.parseRoute(e.pathname,!0),n={protocol:t,server:e.hostname,port:s,...r,query:e.searchParams.toString()};return this.validate(n)?n:null}parseRoute(e,t){let s={route:"",query:e.includes("?")?e.slice(e.indexOf("?")+1):""},n=e.split("?")[0].split("/"),o=n.at(-1);o.split(".").length>1&&(s.type=o.split(".").at(-1));for(let u=0;u<n.length;u++){let l=n[u];if(this.expectedKeys.includes(l)){n[u+1]&&(s[l]=n[u+1]),u++;continue}l!==""&&(s.route+="/"+l)}return t||this.validate(s)?s:null}},g=class{constructor(e,t){this.key=e,t===void 0&&(t={}),this.required=t.required!==void 0?t.required:!1,this.expected=t.expected!==void 0?t.expected:!1,this.enum=t.enum!==void 0?t.enum:null}validate(e){if(this.required!==null&&this.required&&!(this.key in e))return!1;let t=e[this.key];return!(this.key in e&&this.enum!==null&&!this.enum.includes(t))}},k=class extends g{constructor(e,t){super(e,t),t===void 0&&(t={}),this.minLength=t.minLength!==void 0?t.minLength:null,this.maxLength=t.maxLength!==void 0?t.maxLength:null,this.pattern=t.pattern!==void 0?t.pattern:null}validate(e){if(!super.validate(e))return!1;if(!(this.key in e))return!0;let t=e[this.key];return!(typeof t!="string"||this.minLength!==null&&t.length<this.minLength||this.maxLength!==null&&t.length>this.maxLength||this.pattern!==null&&!t.match(this.pattern))}},v=class extends g{constructor(e,t){super(e,t),t===void 0&&(t={}),this.minValue=t.minValue!==void 0?t.minValue:null,this.maxValue=t.maxValue!==void 0?t.maxValue:null}validate(e){if(!super.validate(e))return!1;if(!(this.key in e))return!0;let t=e[this.key];return!(typeof t!="number"||this.minValue!==null&&t<this.minValue||this.maxValue!==null&&t>this.maxValue)}},E=class extends g{constructor(e,t){super(e,t)}validate(e){return super.validate(e)?this.key in e?typeof e[this.key]=="boolean":!0:!1}},S=class extends g{constructor(e,t){super(e,t)}validate(e){return super.validate(e)?this.key in e?e[this.key]===null:!0:!1}},y=class extends g{constructor(e,t){super(e,t)}validate(e){return super.validate(e)?this.key in e?e[this.key]===void 0:!0:!1}},b=class extends g{constructor(e,t){super(e,t),t===void 0&&(t={}),this.minLength=t.minLength!==void 0?t.minLength:null,this.maxLength=t.maxLength!==void 0?t.maxLength:null}validate(e){if(!super.validate(e))return!1;if(!(this.key in e))return!0;let t=e[this.key];return!(!Array.isArray(t)||this.minLength!==null&&t.length<this.minLength||this.maxLength!==null&&t.length>this.maxLength)}},L=class extends g{constructor(e,t){super(e,t)}validate(e){if(!super.validate(e))return!1;if(!(this.key in e))return!0;let t=e[this.key];return typeof t=="object"&&!Array.isArray(t)}},w=class extends g{constructor(e,t,s){if(super(e,s),t.some(r=>r.key!==e))throw new Error(`Cannot create a GroupValidator from validators with different keys.
${JSON.stringify(t)}`);this.validators=t}validate(e){return super.validate(e)?this.key in e?this.validators.some(t=>t.validate(e)):!0:!1}};d.StringValidator=k;d.NumberValidator=v;d.BooleanValidator=E;d.NullValidator=S;d.UndefinedValidator=y;d.ArrayValidator=b;d.ObjectValidator=L;d.GroupValidator=w;T.exports=d});var H=h((Ke,G)=>{var V=class{constructor(e){this.mainMessage=null,this.messageBuffer=[],this.length=e}get isFull(){return this.messageBuffer.length>=this.length}push(e){if(this.isFull)throw new Error("Cannot append more data to BinaryBuffer, length exceeded.");this.messageBuffer.push(e)}};G.exports=V});var M=h((Qe,$)=>{var C=class i{constructor(e,t,s,r,n,o){this.o=e,this.n=t,this.m=s,this.r=r,this.b=n,this.i=o!==void 0?o:null,this.s=null,this.f=null}get origin(){return this.o}set origin(e){this.o=e}get network(){return this.n}set network(e){this.n=e}get method(){return this.m}set method(e){this.m=e}get route(){return this.r}set route(e){this.r=e}get body(){return this.b}set body(e){this.b=e}get id(){return this.i}set id(e){this.i=e}get secret(){return this.s}set secret(e){this.s=e}get frameCount(){return this.f}set frameCount(e){this.f=e}static fromString(e){let t=JSON.parse(e);if([t.o,t.n,t.m,t.r,t.b].some(r=>r===void 0))throw new Error(`Cannot parse ToolSocketMessageString, required value is undefined: ${JSON.stringify(t)}`);let s=new i(t.o,t.n,t.m,t.r,t.b,t.i);return s.s=t.s!==void 0?t.s:null,s.f=t.f!==void 0?t.f:null,s}};$.exports=C});var p=h((Ye,Z)=>{function de(i){return new Uint8Array([i>>24&255,i>>16&255,i>>8&255,i&255])}function ge(i){return i[0]*Math.pow(2,24)+(i[1]<<16)+(i[2]<<8)+i[3]}function fe(i){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",t="";for(let s=0;s<i;s++)t+=e[Math.floor(Math.random()*e.length)];return t}function pe(i,e){let t=new URL(i);for(let[s,r]of e.entries())t.searchParams.set(s,r);return t}var F=typeof window<"u",me=F?WebSocket:ce("ws");Z.exports={intToByte:de,byteToInt:ge,generateUniqueId:fe,addSearchParams:pe,isBrowser:F,WebSocketWrapper:me}});var P=h((je,W)=>{var{intToByte:we,byteToInt:ke}=p(),z=M(),ve=new TextEncoder,Ee=new TextDecoder,I=class i{constructor(e,t){this.message=e,this.binaryData=t}toBinary(){if(Array.isArray(this.binaryData))throw new Error("Cannot convert array-based binary data to single binary.");let e=ve.encode(JSON.stringify(this.message)),t=we(e.length),s=this.binaryData?new Uint8Array(this.binaryData):null,r=s?s.length:0,n=new Uint8Array(t.length+e.length+r);return n.set(t,0),n.set(e,t.length),s&&n.set(s,t.length+e.length),n}static fromString(e){return new i(z.fromString(e),null)}static fromBinary(e){let t=ke(e.slice(0,4)),s=z.fromString(Ee.decode(e.slice(4,t+4))),r=e.slice(t+4,e.length);return new i(s,r)}static fromBinaryBuffer(e){if(!e.isFull)throw new Error("Cannot create a MessageBundle from a BinaryBuffer that is not full.");let t=e.mainMessage,s=[];return e.messageBuffer.forEach(r=>{s.push(r)}),new i(t,s)}};W.exports=I});var X=h((et,J)=>{var Se=M(),ye=P(),_=class{constructor(e,t){if(!t.id)throw new Error("Cannot create ToolSocketResponse for message with no ID.");this.toolSocket=e,this.originalMessage=t,this.sent=!1}send(e,t){if(this.sent){console.error("Attempted to send response, but response was already sent.");return}this.sent=!0,e==null&&(e=204);let s=new Se(this.toolSocket.origin,this.originalMessage.network,"res",this.originalMessage.route,e,this.originalMessage.id);this.originalMessage.secret&&(s.secret=this.originalMessage.secret);let r=new ye(s,t);this.toolSocket.send(r,null)}};J.exports=_});var D=h((tt,K)=>{var be=["css","csv","dat","fbx","gif","glb","htm","html","jpg","jpeg","js","json","map","mp4","obj","otf","pdf","ply","png","pvs","pvz","splat","svg","ttf","wasm","webm","webp","woff","xml","zip","3dt"],Le=["action","beat","delete","get","io","keys","message","new","patch","ping","post","pub","put","res","sub","unsub","meta"];K.exports={MAX_MESSAGE_SIZE:314572800,VALID_FILETYPES:be,VALID_METHODS:Le}});var x=h((st,Y)=>{var a=A(),{MAX_MESSAGE_SIZE:Q,VALID_FILETYPES:Me,VALID_METHODS:xe}=D(),f={n:/^[A-Za-z0-9_]*$/,i:/^[A-Za-z0-9_]*$/,s:/^[A-Za-z0-9_]*$/,r:/^[A-Za-z0-9_/?:&+.%=-]*$/,query:/^[A-Za-z0-9~!@$%^&*()\-_=+{}|;:,./?]*$/,route:/^[A-Za-z0-9/~!@$%^&*()\-_=+|;:,.]*$/,server:/^[A-Za-z0-9~!@$%^&*()\-_=+|;:,.]*$/},qe=new a([new a.StringValidator("n",{minLength:1,maxLength:25,pattern:f.n,required:!0,expected:!0}),new a.StringValidator("type",{enum:Me}),new a.StringValidator("protocol",{enum:["spatialtoolbox","ws","wss","http","https"]}),new a.StringValidator("query",{minLength:0,maxLength:2e3,pattern:f.query}),new a.StringValidator("route",{minLength:0,maxLength:2e3,pattern:f.route}),new a.StringValidator("server",{minLength:0,maxLength:2e3,pattern:f.server}),new a.NumberValidator("port",{minValue:0,maxValue:99999})]),Ae=new a([new a.GroupValidator("i",[new a.StringValidator("i",{minLength:1,maxLength:22,pattern:f.i}),new a.NullValidator("i"),new a.UndefinedValidator("i")]),new a.StringValidator("o",{enum:["server","client","web","edge","proxy","parallel"],required:!0}),new a.StringValidator("n",{minLength:1,maxLength:25,pattern:f.n,required:!0}),new a.StringValidator("m",{enum:xe,required:!0}),new a.StringValidator("r",{minLength:0,maxLength:2e3,pattern:f.r,required:!0}),new a.GroupValidator("b",[new a.BooleanValidator("b"),new a.ArrayValidator("b",{minLength:0,maxLength:Q}),new a.NumberValidator("b"),new a.StringValidator("b",{minLength:0,maxLength:Q}),new a.ObjectValidator("b")],{required:!0}),new a.GroupValidator("s",[new a.StringValidator("s",{minLength:0,maxLength:45,pattern:f.s}),new a.NullValidator("s"),new a.UndefinedValidator("s")]),new a.GroupValidator("f",[new a.NumberValidator("f",{minValue:1,maxValue:99}),new a.NullValidator("f"),new a.UndefinedValidator("f")])]);Y.exports={URL_SCHEMA:qe,MESSAGE_BUNDLE_SCHEMA:Ae}});var O=h((rt,re)=>{var Ve=H(),Ce=M(),Ie=X(),q=P(),{generateUniqueId:Pe,addSearchParams:_e,isBrowser:j,WebSocketWrapper:m}=p(),{VALID_METHODS:ee,MAX_MESSAGE_SIZE:te}=D(),{URL_SCHEMA:se,MESSAGE_BUNDLE_SCHEMA:U}=x(),N=class i{constructor(e,t,s){this.url=null,this.networkId=null,this.origin=null,this.eventCallbacks={},this.responseCallbacks={},this.binaryBuffer=null,this.queuedMessages=[],this.socket=null,e?this.connect(e,t,s):j&&(e=new URL(window.location.href),e.protocol=e.protocol.replace("http","ws"),e.hash="",this.connect(e,t,s)),this.configureDefaultRoutes(),this.configureAliases()}get network(){return this.networkId}get readyState(){return this.socket?this.socket.readyState:m.CLOSED}get connected(){return this.socket&&this.socket.readyState===this.socket.OPEN}connect(e,t,s){if(this.socket&&this.socket.close(),t)this.networkId=t;else{let n=se.parseUrl(e);n?this.networkId=n.n||"io":this.networkId="io"}this.origin=s||(j?"web":"server");let r=new URLSearchParams({networkID:this.networkId});this.url=_e(e,r),this.socket=new m(this.url,[],{maxPayload:te}),this.configureSocket()}addEventListener(e,t){this.eventCallbacks[e]||(this.eventCallbacks[e]=[]),this.eventCallbacks[e].push(t)}triggerEvent(e,...t){this.eventCallbacks[e]&&this.eventCallbacks[e].forEach(s=>s(...t))}removeAllListeners(){this.eventCallbacks=[]}close(){this.socket.close()}configureDefaultRoutes(){this.addEventListener("ping",(e,t,s,r,n)=>{s.send("pong"),n&&n.message.network!=="toolbox"&&n.message.network!==this.networkId&&(this.triggerEvent("network",n.message.network,this.networkId,n.message),this.networkId=n.message.network)}),this.addEventListener("meta",(e,t,s,r,n)=>{e==="requestParallel"?this.triggerEvent("requestParallel",t):e==="confirmParallel"?this.triggerEvent("confirmParallel",t):console.warn(`Received unknown meta route: "${e}"`)}),this.addEventListener("io",(e,t,s,r)=>{ee.includes(e)&&console.warn(`Received IO message with route: "${e}", which cannot be distinguished from the request method with the same name. Please pick a different route.`),this.triggerEvent(e,t,r)}),this.addEventListener("res",(e,t,s,r,n)=>{n&&n.message.id&&this.responseCallbacks[n.message.id]&&(this.responseCallbacks[n.message.id](n.message.body,n.binaryData),delete this.responseCallbacks[n.message.id])})}configureSocket(){this.socket.binaryType="arraybuffer",this.socket.addEventListener("open",e=>{this.triggerEvent("open",e),this.triggerEvent("connect",e),this.triggerEvent("connected",e),this.triggerEvent("status",this.socket.readyState),this.sendQueuedMessages()}),this.socket.addEventListener("close",e=>{this.triggerEvent("close",e),this.triggerEvent("disconnect",e),this.triggerEvent("status",this.socket.readyState)}),this.socket.addEventListener("error",e=>{this.triggerEvent("error",e)}),this.socket.addEventListener("message",e=>{this.triggerEvent("rawMessage",e.data),typeof e.data=="string"?this.routeMessage(e.data):this.routeMessage(new Uint8Array(e.data))}),this.setupPingInterval()}setupPingInterval(){let e=()=>{this.ping("action/ping",null,()=>{this.triggerEvent("pong")})},t=setInterval(e,2e3);e(),this.socket.addEventListener("close",()=>{clearInterval(t)})}routeMessage(e){let t=null,s=0;if(typeof e=="string")try{if(t=q.fromString(e),s=e.length,t.message.frameCount!==null){this.binaryBuffer=new Ve(t.message.frameCount),this.binaryBuffer.mainMessage=t.message;return}}catch{console.warn("failed to process stringified message, dropping",e),this.triggerEvent("droppedMessage",e);return}else if(this.binaryBuffer){if(this.binaryBuffer.push(e),!this.binaryBuffer.isFull)return;try{t=q.fromBinaryBuffer(this.binaryBuffer),s=e.length,this.binaryBuffer=null}catch{console.warn("failed to process full binary buffer, dropping",e),this.triggerEvent("droppedMessage",e);return}}else try{t=q.fromBinary(e),s=e.length}catch{console.warn("failed to process binary message, dropping",e),this.triggerEvent("droppedMessage",e);return}if(!U.validate(t.message)){console.warn("message schema validation failed, dropping",t.message,U.failedValidator),this.triggerEvent("droppedMessage",e);return}if(s>te){console.warn("message too large, dropping",t.message,s),this.triggerEvent("droppedMessage",e);return}if(ee.includes(t.message.method)){let r=t.message.id?new Ie(this,t.message):null;this.triggerEvent(t.message.method,t.message.route,t.message.body,r,t.binaryData,t)}}sendQueuedMessages(){this.queuedMessages.forEach(({messageBundle:e,callback:t})=>{this.send(e,t)}),this.queuedMessages=[]}send(e,t){if(!this.connected){this.queuedMessages.push({messageBundle:e,callback:t});return}if(t&&(e.message.id=Pe(8),this.responseCallbacks[e.message.id]=t),e.binaryData)if(Array.isArray(e.binaryData)){e.message.frameCount=e.binaryData.length;let s=JSON.stringify(e.message);this.socket.send(s),this.triggerEvent("rawSend",s),e.binaryData.forEach(r=>{let n=r;this.socket.send(n),this.triggerEvent("rawSend",n)})}else{let s=e.toBinary();this.socket.send(s),this.triggerEvent("rawSend",s)}else{let s=JSON.stringify(e.message);this.socket.send(s),this.triggerEvent("rawSend",s)}this.triggerEvent("send",e)}emit(e,t,s){this.io(e,t,null,s)}sendMethod(e,t,s,r,n){n||(n=null);let o=new Ce(this.origin,this.networkId,e,t,s),u=new q(o,n);this.send(u,r)}action(e,t,s,r){this.sendMethod("action",e,t,s,r)}beat(e,t,s,r){this.sendMethod("beat",e,t,s,r)}delete(e,t,s,r){this.sendMethod("delete",e,t,s,r)}get(e,t,s,r){this.sendMethod("get",e,t,s,r)}io(e,t,s,r){this.sendMethod("io",e,t,s,r)}keys(e,t,s,r){this.sendMethod("keys",e,t,s,r)}message(e,t,s,r){this.sendMethod("message",e,t,s,r)}new(e,t,s,r){this.sendMethod("new",e,t,s,r)}patch(e,t,s,r){this.sendMethod("patch",e,t,s,r)}ping(e,t,s,r){this.sendMethod("ping",e,t,s,r)}post(e,t,s,r){this.sendMethod("post",e,t,s,r)}pub(e,t,s,r){this.sendMethod("pub",e,t,s,r)}put(e,t,s,r){this.sendMethod("put",e,t,s,r)}res(e,t,s,r){this.sendMethod("res",e,t,s,r)}sub(e,t,s,r){this.sendMethod("sub",e,t,s,r)}unsub(e,t,s,r){this.sendMethod("unsub",e,t,s,r)}meta(e,t,s,r){this.sendMethod("meta",e,t,s,r)}configureAliases(){this.on=this.addEventListener,this.emitInt=this.triggerEvent,this.dataPackageSchema=U.oldFormat,this.routeSchema=se.oldFormat,this.OPEN=m.OPEN,this.CONNECTING=m.CONNECTING,this.CLOSING=m.CLOSING,this.CLOSED=m.CLOSED}static makeParallelSocket(e){return new i(e.url,e.networkId,"parallel")}};re.exports=N});var ie=h((nt,ne)=>{var De=O(),R=class extends De{constructor(e,t){super(),this.socket=e,this.networkId="toolbox",this.origin=t.origin,this.server=t,this.configureSocket()}requestParallelSocket(){return this.server.requestParallelSocket(this)}};ne.exports=R});var oe=h((it,ae)=>{var{WebSocketWrapper:Ue}=p(),{URL_SCHEMA:Ne,MESSAGE_BUNDLE_SCHEMA:Oe}=x(),Re=ie(),{generateUniqueId:Be}=p(),B=class{constructor(e,t){this.origin=t||"server",this.server=new Ue.Server(e),this.sockets=[],this.eventCallbacks={},this.pendingParallelRequests=new Map,this.server.on("listening",(...s)=>{this.triggerEvent("listening",...s)}),this.server.on("connection",s=>{let r=new Re(s,this);this.sockets.push(r),this.triggerEvent("connection",r),r.on("confirmParallel",n=>{this.pendingParallelRequests.has(n)&&(this.pendingParallelRequests.get(n)(r),this.pendingParallelRequests.delete(n))}),s.on("close",()=>{this.sockets.splice(this.sockets.indexOf(r),1)})}),this.server.on("close",(...s)=>{this.triggerEvent("close",...s)}),this.configureAliases()}addEventListener(e,t){this.eventCallbacks[e]||(this.eventCallbacks[e]=[]),this.eventCallbacks[e].push(t)}triggerEvent(e,...t){this.eventCallbacks[e]&&this.eventCallbacks[e].forEach(s=>s(...t))}removeAllListeners(){this.eventCallbacks=[]}configureAliases(){this.on=this.addEventListener,this.emitInt=this.triggerEvent,this.dataPackageSchema=Oe.oldFormat,this.routeSchema=Ne.oldFormat,this.server.server=this.server}requestParallelSocket(e){let t=Be(8),s=5*1e3;if(e.supportsParallelSocket===void 0){e.meta("requestParallel",t,null,null);let r=!1,n,o,u=new Promise((l,he)=>{n=l,o=he}).then(l=>(e.supportsParallelSocket=!0,r=!0,l));return this.pendingParallelRequests.set(t,n),setTimeout(()=>{r||(this.pendingParallelRequests.delete(t),e.supportsParallelSocket===void 0?(e.supportsParallelSocket=!1,o("Unable to create parallel socket connection. Might not be supported by client.")):o("Unable to create parallel socket connection. Client does support it, but there's likely a network issue."))},s),u}else if(e.supportsParallelSocket){e.meta("requestParallel",t,null,null);let r,n=new Promise(o=>{r=o});return this.pendingParallelRequests.set(t,r),n}else return Promise.reject("Unable to create parallel socket connection. Might not be supported by client.")}close(){this.server.close()}};ae.exports=B});var We=h((at,ue)=>{var Te=A(),c=O(),Ge=oe(),{intToByte:He,byteToInt:$e,generateUniqueId:le,isBrowser:Fe}=p(),{URL_SCHEMA:Ze,MESSAGE_BUNDLE_SCHEMA:ze}=x();c.MESSAGE_BUNDLE_SCHEMA=ze;c.URL_SCHEMA=Ze;c.Io=c;c.intToByte=He;c.byteToInt=$e;c.uuidShort=le;c.generateUniqueId=le;c.Schema=Te;Fe?window.io=new c:c.Server=Ge;ue.exports=c});return We();})();
