<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        path {
            stroke-width: 6px;
            stroke: #00ffff;
            fill: rgba(0, 255, 255, 0.3);
        }
        path.active {
            stroke: #00ff00;
            fill: #00ff00;
        }
        #activation {
            stroke: #00ff00;
            fill: #00ff00;
        }
        path.slice {
            display: none;
        }
        path.slice.active {
            display: block;
            stroke: #00ff00;
            fill: #00ff00;
        }
    </style>
    <script src="object.js"></script>
    <script src="resources/pep.min.js"></script>
</head>
<body>
<svg id="container" width="526" height="526" version="1.1" xmlns="http://www.w3.org/2000/svg" touch-action="none">
    <defs>
        <clipPath id="kinetic-outline">
            <path id="sliceN" class="slice" d="M159.5 160 L 260 109.5 L 360.5 160 L 260 260.5 Z"></path>
            <path id="sliceE" class="slice" d="M259.5 260 L 360 159.5 L 410.5 260 L 360 360.5 Z"></path>
            <path id="sliceS" class="slice" d="M260 259.5 L 360.5 360 L 260 410.5 L 159.5 360 Z"></path>
            <path id="sliceW" class="slice" d="M260.5 260 L 160 360.5 L 109.5 260 L 160 159.5 Z"></path>
        </clipPath>
    </defs>

    <g transform="translate(3 3)">
        <path d="M160 160 L 260 110 L 360 160 L 410 260 L 360 360 L 260 410 L 160 360 L 110 260 Z"></path>

        <path id="activation" d="M160 160 L 260 110 L 360 160 L 410 260 L 360 360 L 260 410 L 160 360 L 110 260 Z" clip-path="url(#kinetic-outline)"></path>
        <path id="arrowN1" d="M160 75 L 160 50 L 260 0 L 360 50 L 360 75 L 260 25 Z"></path>
        <path id="arrowN0" d="M160 130 L 160 105 L 260 55 L 360 105 L 360 130 L 260 80 Z"></path>


        <g transform="translate(520 0) rotate(90)">
            <path id="arrowE1" d="M160 75 L 160 50 L 260 0 L 360 50 L 360 75 L 260 25 Z"></path>
            <path id="arrowE0" d="M160 130 L 160 105 L 260 55 L 360 105 L 360 130 L 260 80 Z"></path>
        </g>
        <g transform="translate(520 520) rotate(180)">
            <path id="arrowS1" d="M160 75 L 160 50 L 260 0 L 360 50 L 360 75 L 260 25 Z"></path>
            <path id="arrowS0" d="M160 130 L 160 105 L 260 55 L 360 105 L 360 130 L 260 80 Z"></path>
        </g>
        <g transform="translate(0 520) rotate(270)">
            <path id="arrowW1" d="M160 75 L 160 50 L 260 0 L 360 50 L 360 75 L 260 25 Z"></path>
            <path id="arrowW0" d="M160 130 L 160 105 L 260 55 L 360 105 L 360 130 L 260 80 Z"></path>
        </g>
    </g>
</svg>

<script>
    var container = document.querySelector('#container');
    var activation = document.querySelector('#activation');

    var sliceN = document.querySelector('#sliceN');
    var sliceE = document.querySelector('#sliceE');
    var sliceS = document.querySelector('#sliceS');
    var sliceW = document.querySelector('#sliceW');

    var arrowN1 = document.querySelector('#arrowN1');
    var arrowN0 = document.querySelector('#arrowN0');
    var arrowE1 = document.querySelector('#arrowE1');
    var arrowE0 = document.querySelector('#arrowE0');
    var arrowS1 = document.querySelector('#arrowS1');
    var arrowS0 = document.querySelector('#arrowS0');
    var arrowW1 = document.querySelector('#arrowW1');
    var arrowW0 = document.querySelector('#arrowW0');

    var properties = {
        valueX: 0.5,
        valueY: 0.5
    };
    var height = 520;
    var width = 520;
    var pointers = {};

    // misc constants
    var deadzone = 30;
    var arrowLevel0 = 160;
    var arrowLevel1 = 210;

    function onPointerDown(e) {
        e.preventDefault();
        pointers[e.pointerId] = true;
        onPointerMove(e);
    }

    function onPointerMove(e) {
        e.preventDefault();
        if (!pointers[e.pointerId]) {
            return;
        }

        var rect = container.getBoundingClientRect();

        var dY = e.clientY - rect.top - 258;
        var dX = e.clientX - rect.left - 258;
        var absY = Math.abs(dY);
        var absX = Math.abs(dX);
        
        if (absY < deadzone) {
            absY = 0;
            dY = 0;
        }
        if (absX < deadzone) {
            absX = 0;
            dX = 0;
        }
        
        properties.valueX = limit(dX / width + 0.5);
        properties.valueY = limit(dY / height + 0.5);

        setUIValue(properties.valueX, properties.valueY);

        hybridObject.write('valueX', properties.valueX);
        hybridObject.write('valueY', properties.valueY);
    }
    
    function setUIValue(valueX, valueY) {

        var dX = (valueX - 0.5) * width;
        var dY = (valueY - 0.5) * height;
        var absX = Math.abs(dX);
        var absY = Math.abs(dY);
        
        var scale = Math.sqrt(dY * dY + dX * dX) / 150;
        if (scale > 153 / 150) {
            scale = 153 / 150;
        }
        if (scale > deadzone / 150) {
            var centerDiff = 260 - 260 * scale;

            activation.setAttribute('transform', 'translate(' + centerDiff +
                ',' + centerDiff + ') scale(' + scale + ')');
        } else {
            activation.setAttribute('transform', 'scale(0)');
        }

        var activePaths = [].slice.call(container.querySelectorAll('path.active'));
        activePaths.forEach(function(path) {
            path.classList.remove('active');
        });

        var arrowX0 = arrowW0;
        var arrowX1 = arrowW1;

        if (dX < -deadzone) {
            sliceW.classList.add('active');
        } else if (dX > deadzone) {
            sliceE.classList.add('active');
            arrowX0 = arrowE0;
            arrowX1 = arrowE1;
        }

        if (absX > arrowLevel0) {
            arrowX0.classList.add('active');
        }
        if (absX > arrowLevel1) {
            arrowX1.classList.add('active');
        }

        var arrowY0 = arrowN0;
        var arrowY1 = arrowN1;

        if (dY < -deadzone) {
            sliceN.classList.add('active');
        } else if (dY > deadzone) {
            sliceS.classList.add('active');
            arrowY0 = arrowS0;
            arrowY1 = arrowS1;
        }

        if (absY > arrowLevel0) {
            arrowY0.classList.add('active');
        }
        if (absY > arrowLevel1) {
            arrowY1.classList.add('active');
        }
    }
    
    function limit(value) {
        if (value < 0) {
            return 0;
        }
        if (value > 1) {
            return 1;
        }
        return value;
    }

    function onPointerUp(e) {
        e.preventDefault();
        pointers[e.pointerId] = false;
    }

    function ready() {
        container.addEventListener('pointermove', onPointerMove);
        container.addEventListener('pointerdown', onPointerDown);
        container.addEventListener('pointerup', onPointerUp);
        container.addEventListener('pointercancel', onPointerUp);
    }
    
    ready();

    var hybridObject = new HybridObject();
    hybridObject.addReadListener('valueX', function(e) {
        properties.valueX = e;
        setUIValue(properties.valueX, properties.valueY);
    });
    hybridObject.addReadListener('valueY', function(e) {
        properties.valueY = e;
        setUIValue(properties.valueX, properties.valueY);
    });
    
</script>

</body>
</html>
