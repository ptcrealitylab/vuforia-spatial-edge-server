<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>reality-slider</title>
    <style>
        path {
            stroke-width: 6px;
            stroke: #00ffff;
            fill: rgba(0, 255, 255, 0.3);
        }
        #padUpper.active, #padLower.active {
            stroke: #00ff00;
            fill: rgba(0, 255, 255, 0.3);
        }
        path.active {
            stroke: #00ff00;
            fill: #00ff00;
        }
        #activation {
            stroke: #00ff00;
            fill: #00ff00;
        }
    </style>
    <script src="object.js"></script>
    <script src="resources/pep.min.js"></script>
</head>
<body>
<svg id="container" width="206" height="526" version="1.1" xmlns="http://www.w3.org/2000/svg" touch-action="none">
    <defs>
        <clipPath id="kinetic-outline">
            <path d="M0 260 L 0 160 L 100 110 L 200 160 L 200 360 L 100 410 L 0 360 Z"></path>
        </clipPath>
    </defs>
    <g transform="translate(3 3)" touch-action="none">
        <path id="arrowUpper1" d="M0 75 L 0 50 L 100 0 L 200 50 L 200 75 L 100 25 Z"></path>
        <path id="arrowUpper0" d="M0 130 L 0 105 L 100 55 L 200 105 L 200 130 L 100 80 Z"></path>
        <path id="padUpper" d="M0 260 L 0 160 L 100 110 L 200 160 L 200 260"></path>
        <g transform="translate(200 520) rotate(180)">
            <path id="arrowLower1" d="M0 75 L 0 50 L 100 0 L 200 50 L 200 75 L 100 25 Z"></path>
            <path id="arrowLower0" d="M0 130 L 0 105 L 100 55 L 200 105 L 200 130 L 100 80 Z"></path>
            <path id="padLower" d="M0 260 L 0 160 L 100 110 L 200 160 L 200 260"></path>
        </g>
        <rect id="activation" x="0" y="255" width="200" height="0"
              clip-path="url(#kinetic-outline)"/>
    </g>

</svg>

<script>
    
    var container = document.querySelector('#container');
    var activation = document.querySelector('#activation');
    var padUpper = document.querySelector('#padUpper');
    var padLower = document.querySelector('#padLower');

    var properties = {
        value: 0.5
    };
    var height = 520;
    var width = 200;
    var pointers = {};

    // misc constants
    var deadzone = 10;
    var arrowLevel0 = 160;
    var arrowLevel1 = 210;

    function onPointerDown(e) {
        e.preventDefault();
        pointers[e.pointerId] = true;
        onPointerMove(e);
    }

    function onPointerMove(e) {
        e.preventDefault();
        if (!pointers[e.pointerId]) {
            return;
        }
        var rect = container.getBoundingClientRect();
        var dY = e.clientY - rect.top - height / 2 - 3;
        var absY = Math.abs(dY);

        var deadzone = 10;
        if (absY < deadzone) {
            absY = 0;
            dY = 0;
        }

        var value = dY / height + 0.5;
        if (value < 0) {
            value = 0;
        }
        if (value > 1) {
            value = 1;
        }

        // value = 1 - value;

        setUIValue(value);

        properties.value = value;

        hybridObject.write('value', properties.value);
    }

    function setUIValue(value) {

        // value = 1 - value;

        var dY = (value - 0.5) * height;
        var absY = Math.abs(dY);

        activation.setAttribute('height', absY);

        container.querySelectorAll('path.active').forEach(function(path) {
            path.classList.remove('active');
        });

        var arrow0 = document.querySelector('#arrowUpper0');
        var arrow1 = document.querySelector('#arrowUpper1');

        if (dY < -deadzone) {
            padUpper.classList.add('active');
            activation.setAttribute('y', (height / 2) + dY);
        } else if (dY > deadzone) {
            padLower.classList.add('active');
            activation.setAttribute('y', height / 2);
            arrow0 = document.querySelector('#arrowLower0');
            arrow1 = document.querySelector('#arrowLower1');
        }

        if (absY > arrowLevel0) {
            arrow0.classList.add('active');
        }
        if (absY > arrowLevel1) {
            arrow1.classList.add('active');
        }

    }

    function onPointerUp(e) {
        e.preventDefault();
        pointers[e.pointerId] = false;
    }
    
    function ready() {
        container.addEventListener('pointermove', onPointerMove);
        container.addEventListener('pointerdown', onPointerDown);
        container.addEventListener('pointerup', onPointerUp);
        container.addEventListener('pointercancel', onPointerUp);
    }
    
    ready();
    
    var hybridObject = new HybridObject();
    hybridObject.addReadListener('value', function(e) {
        // console.log('received value ' + e);
        setUIValue(e);
        properties.value = e;
        // hybridObject.write('value', properties.value);
    });
    
    // function setupRealityNode() {
    //     var isDemoMode = window.location.search.indexOf('demo=true') >= 0;
    //
    //     var hybridObject;
    //     if ((typeof HybridObject === 'undefined') || isDemoMode) {
    //         console.warn('HybridObject undefined or isDemoMode');
    //         hybridObject = {
    //             addReadListener: function() {},
    //             write: function() {},
    //             sendCreateNode: function() {}
    //         };
    //     } else {
    //         hybridObject = new HybridObject();
    //     }
    //    
    //    
    //     function realityNodeReady() {
    //         window.addEventListener('message', function(msg) {
    //             var data = JSON.parse(msg.data);
    //             if (!data.hasOwnProperty('demo')) {
    //                 return;
    //             }
    //             if (data.demo) {
    //                 this.startDemonstrating();
    //             } else {
    //                 this.stopDemonstrating();
    //             }
    //         });
    //
    //         hybridObject.sendCreateNode(this.name);
    //     }
    //    
    //     realityNodeReady();
    //    
    // }
    
    // setupRealityNode();
    
</script>

</body>
</html>
